- name: Gather package facts for apt
  package_facts:
    manager: apt

- name: Remove snaps
  shell:
    cmd: snap list {{ item }} && snap remove --purge  {{ item }}
  with_items:
    - gnome-3-38-2004
    - firefox
    - snap-store
    - gtk-common-themes
    - snapd-desktop-integration
  ignore_errors: yes
  when: '"snapd" in ansible_facts.packages'

- name: cleanup snap
  shell:
    cmd:  apt remove --purge -y snapd gnome-software-plugin-snap

- name: remove chromium-codecs-ffmpeg-extra
  apt:
    pkg: chromium-codecs-ffmpeg-extra
    state: absent

- name: get latest chromium package url
  shell: echo "http://packages.linuxmint.com/"$(wget -q -O- "http://packages.linuxmint.com/search.php?release=una&section=any&keyword=chromium" | grep "<b>chromium</b>" -A 4 |grep href |cut -d '"' -f2)
  register: chromium_url

- name: Print chromium URL/Version
  debug:
    msg: "Installing chromium from: {{ chromium_url.stdout }}"

- name: install chrome from deb
  apt:
    deb: "{{ chromium_url.stdout }}"

- name: Chromium should use simple password store ==> does not ask for keyring pwd
  ansible.builtin.replace:
    path: /usr/share/applications/chromium-browser.desktop
    before: '# live site config'
    regexp: 'Exec=chromium'
    replace: 'Exec=chromium %U --password-store=basic'
  when: '"chromium-browser" in ansible_facts.packages'


- name: make sure firefox is installed as .deb and not as snap
  copy:
      dest: "/etc/apt/preferences.d/99mozilla_teamppa"
      mode: '0644'
      content: |
        Package: firefox*
        Pin: release o=LP-PPA-mozillateam
        Pin-Priority: 501

        Package: firefox*
        Pin: release o=Ubuntu
        Pin-Priority: -1

- name: import apt key for mozilla team ppa
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 9BDB3D89CE49EC21
    keyring: /etc/apt/trusted.gpg.d/mozillateam.gpg

- name: Add mozilla team ppa
  apt_repository:
    repo: deb https://ppa.launchpadcontent.net/mozillateam/ppa/ubuntu jammy main
    state: present
    filename: firefox_team_ppa.list

- name: Make system apt update & upgrade
  import_tasks: system_update.yml

- name:
  apt:
    pkg: ['firefox-esr', 'firefox-esr-locale-de']
    state: present
